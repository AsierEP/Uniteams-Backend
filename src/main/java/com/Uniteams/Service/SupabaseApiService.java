package com.Uniteams.Service;

import org.springframework.http.*;
import org.springframework.stereotype.Service;
import org.springframework.web.client.RestTemplate;
import java.util.*;

@Service
public class SupabaseApiService {

    private final String supabaseUrl = "https://zskuikxfcjobpygoueqp.supabase.co/rest/v1";

    // ‚úÖ REEMPLAZA con tu SERVICE_ROLE KEY (debe empezar con eyJhb...)
    private final String apiKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpza3Vpa3hmY2pvYnB5Z291ZXFwIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1OTQ0MzE0NCwiZXhwIjoyMDc1MDE5MTQ0fQ.Q25utwwQYJ5zful7utYTK3JT2zkitGtoxOzCkGlDKiQ";

    private final RestTemplate restTemplate;

    public SupabaseApiService(RestTemplate restTemplate) {
        this.restTemplate = restTemplate;
    }

    private HttpHeaders createHeaders() {
        HttpHeaders headers = new HttpHeaders();
        headers.set("apikey", apiKey);
        headers.set("Authorization", "Bearer " + apiKey);
        headers.setContentType(MediaType.APPLICATION_JSON);
        headers.set("Prefer", "return=representation");
        return headers;
    }

    // Obtener todos los grupos
    public List<Map<String, Object>> getStudyGroups() {
        try {
            String url = supabaseUrl + "/studygroups?select=*";
            HttpEntity<String> entity = new HttpEntity<>(createHeaders());

            ResponseEntity<Map[]> response = restTemplate.exchange(
                    url, HttpMethod.GET, entity, Map[].class);

            // ‚úÖ Esto ya est√° correcto - Supabase devuelve array para m√∫ltiples registros
            return Arrays.asList(response.getBody());
        } catch (Exception e) {
            System.err.println("‚ùå Error obteniendo grupos: " + e.getMessage());
            e.printStackTrace(); // ‚úÖ Agregar stack trace
            return new ArrayList<>();
        }
    }

    // ‚úÖ CORREGIDO: Crear grupo y devolver el ID real
    public Map<String, Object> createStudyGroup(Map<String, Object> groupData) {
        try {
            String url = supabaseUrl + "/studygroups?select=id"; // <-- Pedimos que devuelva el ID

            // Aseg√∫rate de que los headers pidan la representaci√≥n
            HttpHeaders headers = createHeaders();
            headers.set("Prefer", "return=representation,resolution=merge-duplicates");

            HttpEntity<Map<String, Object>> entity = new HttpEntity<>(groupData, headers);

            System.out.println("üöÄ Enviando a Supabase...");

            // Pedimos un Map[] porque Supabase devuelve un array con el objeto creado
            ResponseEntity<Map[]> response = restTemplate.exchange(
                    url, HttpMethod.POST, entity, Map[].class);

            // Si Supabase devuelve un cuerpo y un array no vac√≠o, la creaci√≥n fue exitosa
            if (response.getBody() != null && response.getBody().length > 0) {
                System.out.println("‚úÖ Grupo creado exitosamente en Supabase.");
                // Devolvemos el primer objeto del array, que es nuestro grupo con su ID
                return response.getBody()[0];
            }

            // Si no, devolvemos un error
            System.err.println("‚ùå Supabase devolvi√≥ OK pero sin cuerpo de respuesta.");
            return Map.of("error", "Supabase devolvi√≥ OK pero sin cuerpo de respuesta.");

        } catch (org.springframework.web.client.HttpClientErrorException e) {
            // ‚úÖ ESTE ES EL CATCH M√ÅS IMPORTANTE
            // Captura errores 4xx y 5xx y muestra el error REAL de Supabase
            System.err.println("‚ùå Error REAL de Supabase: " + e.getResponseBodyAsString());
            return Map.of("error", "Error de Supabase: " + e.getResponseBodyAsString());

        } catch (Exception e) {
            // Captura gen√©rica para otros errores (red, etc.)
            System.err.println("‚ùå Error creando grupo: " + e.getMessage());
            e.printStackTrace();
            return Map.of("error", e.getMessage());
        }
    }

    // ‚úÖ NUEVO: Obtener perfil del usuario
    public Map<String, Object> getUserProfile(String userId) {
        try {
            String url = supabaseUrl + "/profiles?id=eq." + userId + "&select=*";
            HttpEntity<String> entity = new HttpEntity<>(createHeaders());

            ResponseEntity<Map[]> response = restTemplate.exchange(
                    url, HttpMethod.GET, entity, Map[].class);

            Map[] profiles = response.getBody();
            if (profiles != null && profiles.length > 0) {
                return profiles[0];
            }
            return null;
        } catch (Exception e) {
            System.err.println("‚ùå Error obteniendo perfil del usuario: " + e.getMessage());
            e.printStackTrace();
            return null;
        }
    }

    // ‚úÖ NUEVO: Actualizar perfil del usuario
    public boolean updateUserProfile(String userId, Map<String, Object> updateData) {
        try {
            String url = supabaseUrl + "/profiles?id=eq." + userId;
            HttpEntity<Map<String, Object>> entity = new HttpEntity<>(updateData, createHeaders());

            ResponseEntity<String> response = restTemplate.exchange(
                    url, HttpMethod.PATCH, entity, String.class);

            System.out.println("‚úÖ Perfil actualizado exitosamente para usuario: " + userId);
            return true;

        } catch (Exception e) {
            System.err.println("‚ùå Error actualizando perfil del usuario: " + e.getMessage());
            e.printStackTrace();
            return false;
        }
    }

    // ‚úÖ NUEVO: Actualizar grupo de estudio
    public boolean updateStudyGroup(String groupId, Map<String, Object> updateData) {
        try {
            String url = supabaseUrl + "/studygroups?id=eq." + groupId;
            HttpEntity<Map<String, Object>> entity = new HttpEntity<>(updateData, createHeaders());

            ResponseEntity<String> response = restTemplate.exchange(
                    url, HttpMethod.PATCH, entity, String.class);

            System.out.println("‚úÖ Grupo actualizado exitosamente: " + groupId);
            return true;

        } catch (Exception e) {
            System.err.println("‚ùå Error actualizando grupo: " + e.getMessage());
            e.printStackTrace();
            return false;
        }
    }

    // ‚úÖ NUEVO: Obtener grupo por ID
    public Map<String, Object> getStudyGroupById(String groupId) {
        try {
            String url = supabaseUrl + "/studygroups?id=eq." + groupId + "&select=*";
            HttpEntity<String> entity = new HttpEntity<>(createHeaders());

            ResponseEntity<Map[]> response = restTemplate.exchange(
                    url, HttpMethod.GET, entity, Map[].class);

            Map[] groups = response.getBody();
            if (groups != null && groups.length > 0) {
                return groups[0];
            }
            return null;
        } catch (Exception e) {
            System.err.println("‚ùå Error obteniendo grupo por ID: " + e.getMessage());
            e.printStackTrace();
            return null;
        }
    }

    // ‚úÖ NUEVO: Obtener m√∫ltiples grupos por IDs
    public List<Map<String, Object>> getStudyGroupsByIds(List<String> groupIds) {
        try {
            if (groupIds == null || groupIds.isEmpty()) {
                return new ArrayList<>();
            }

            // Crear filtro IN para m√∫ltiples IDs
            String idsFilter = String.join(",", groupIds);
            String url = supabaseUrl + "/studygroups?id=in.(" + idsFilter + ")&select=*";
            HttpEntity<String> entity = new HttpEntity<>(createHeaders());

            ResponseEntity<Map[]> response = restTemplate.exchange(
                    url, HttpMethod.GET, entity, Map[].class);

            Map[] groups = response.getBody();
            if (groups != null && groups.length > 0) {
                return Arrays.asList(groups);
            }
            return new ArrayList<>();

        } catch (Exception e) {
            System.err.println("‚ùå Error obteniendo grupos por IDs: " + e.getMessage());
            e.printStackTrace();
            return new ArrayList<>();
        }
    }

    // ‚úÖ NUEVO: Verificar si usuario est√° en grupo
    public boolean isUserInGroup(String userId, String groupId) {
        try {
            Map<String, Object> profile = getUserProfile(userId);
            if (profile != null && profile.containsKey("study_groups")) {
                Object studyGroups = profile.get("study_groups");
                if (studyGroups instanceof List) {
                    return ((List<?>) studyGroups).contains(groupId);
                }
            }
            return false;
        } catch (Exception e) {
            System.err.println("‚ùå Error verificando membres√≠a de grupo: " + e.getMessage());
            e.printStackTrace();
            return false;
        }
    }

    // ‚úÖ NUEVO: Obtener todos los perfiles (√∫til para debugging)
    public List<Map<String, Object>> getAllProfiles() {
        try {
            String url = supabaseUrl + "/profiles?select=*";
            HttpEntity<String> entity = new HttpEntity<>(createHeaders());

            ResponseEntity<Map[]> response = restTemplate.exchange(
                    url, HttpMethod.GET, entity, Map[].class);

            Map[] profiles = response.getBody();
            if (profiles != null && profiles.length > 0) {
                return Arrays.asList(profiles);
            }
            return new ArrayList<>();
        } catch (Exception e) {
            System.err.println("‚ùå Error obteniendo perfiles: " + e.getMessage());
            e.printStackTrace();
            return new ArrayList<>();
        }
    }
}